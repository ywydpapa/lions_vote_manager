<!DOCTYPE html>
<html lang="en">
<head>
    {% include '/common/header.html' %}
</head>
<body class="d-flex flex-column h-100 bg-light">
<main class="flex-shrink-0">
    <!-- Navigation-->
    {% include '/common/topnav.html' %}
    <!-- Page Content-->
    <div class="container px-5 my-5">
        <div class="text-center mb-5">
            <h1 class="display-5 fw-bolder mb-0"><span class="text-gradient d-inline">방문 스케줄</span></h1>
        </div>
        <div class="row gx-5 justify-content-center">
            <div class="col-lg-11 col-xl-9 col-xxl-8">
                <div id="scheduleRoot"></div>
                <style>
                  .day-toggle { cursor: pointer; }
                    .day-card {
                        margin-bottom: 16px;
                    }

                    .schedule-grid {
                        display: grid;
                        grid-template-columns: 1fr;
                    }

                    .slot {
                        border-top: 1px solid #eef0f3;
                        padding: 10px 14px;
                        background: #fff;
                        min-height: 44px;
                    }

                    .slot:nth-child(2n) {
                        background: #fafbfc;
                    }

                    .slot:first-child {
                        border-top: 0;
                    }

                    .time {
                        font-weight: 700;
                        color: #495057;
                        font-variant-numeric: tabular-nums;
                    }
                    .slot a:hover { text-decoration: underline !important; }

                    /* 컨테이너 폭(가로 전체)로 꽉 차게 */
                    .schedule-wrap {
                        width: 100%;
                    }

                    /* 10분 슬롯을 세로로 쌓는 타임라인 */
                    .schedule-grid {
                        display: grid;
                        grid-template-columns: 1fr; /* 가로 전체 */
                    }

                    .slot {
                        position: relative;
                        min-height: 44px; /* 한 슬롯 높이 */
                        border-top: 1px solid #eef0f3; /* 구분선 */
                        padding: 10px 14px;
                        background: #fff;
                    }

                    .slot:first-child {
                        border-top: 0;
                    }

                    .time {
                        font-weight: 700;
                        color: #495057;
                        font-variant-numeric: tabular-nums;
                    }

                    /* 가독성을 위한 홀수 줄 배경 */
                    .slot:nth-child(2n) {
                        background: #fafbfc;
                    }
                </style>
            </div>
        </div>
    </div>
</main>
<!-- Footer-->
{% include '/common/footer.html' %}
{% include '/common/adscript.html' %}


<script>
    const payload = { reservs: {{ reservs | tojson }} };
  const START_HOUR = 9;
  const END_HOUR = 18;
  const STEP_MIN = 20;

  const pad2 = (n) => String(n).padStart(2, '0');
  const ymd = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const hm = (d) => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  const koDayTitle = (d) => `${d.getMonth()+1}월 ${d.getDate()}일`;

    function reservDtlUrl(reservNo) {
    const n = Number(reservNo);
    if (!Number.isFinite(n)) return '#';
    return `/view_reservdtl/${n}`;
  }

  function escapeHtml(s) {
    return String(s ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");
  }

  function floorToStep(date, stepMin) {
    const d = new Date(date);
    const m = d.getMinutes();
    d.setMinutes(m - (m % stepMin), 0, 0);
    return d;
  }

  const reservs = (payload.reservs ?? []).map(r => ({ ...r, _dt: new Date(r.reservFrom) }));

  // 날짜별 그룹
  const groups = new Map();
  for (const r of reservs) {
    const key = ymd(r._dt);
    if (!groups.has(key)) groups.set(key, []);
    groups.get(key).push(r);
  }

  const days = Array.from(groups.keys()).sort();
  const root = document.getElementById('scheduleRoot');

  if (days.length === 0) {
    root.innerHTML = `<div class="text-muted p-4">예약이 없습니다.</div>`;
  } else {
    root.innerHTML = days.map(dayKey => {
      const dayDate = new Date(dayKey + 'T00:00:00');
      const list = groups.get(dayKey);
      const count = list.length;

      // 슬롯키(YYYY-MM-DD HH:mm) -> 예약들
      const slotMap = new Map();
      for (const r of list) {
        const floored = floorToStep(r._dt, STEP_MIN);
        const slotKey = `${ymd(floored)} ${hm(floored)}`;
        if (!slotMap.has(slotKey)) slotMap.set(slotKey, []);
        slotMap.get(slotKey).push(r);
      }

      const start = new Date(dayKey + `T${pad2(START_HOUR)}:00:00`);
      const end   = new Date(dayKey + `T${pad2(END_HOUR)}:00:00`);

      const slots = [];
      for (let t = new Date(start); t < end; t = new Date(t.getTime() + STEP_MIN * 60000)) {
        const key = `${ymd(t)} ${hm(t)}`;
        const items = slotMap.get(key) ?? [];

          const lines = items.map(r => `
          <a class="d-block small text-decoration-none py-1"
             href="${reservDtlUrl(r.reservNo)}">
            <span class="fw-semibold text-body">${escapeHtml(r.visitorName)}</span>
            <span class="text-muted">(${r.visitCnt}명)</span>
          </a>
        `).join('');


        slots.push(`
          <div class="slot">
            <div class="d-flex justify-content-between align-items-start">
              <div class="time">${hm(t)}</div>
              <div class="text-end" style="min-width:70%">
                ${lines || `<div class="text-muted small">-</div>`}
              </div>
            </div>
          </div>
        `);
      }
            const collapseId = `day_${dayKey.replaceAll('-', '')}`; // 예: day_20260310
      return `
        <div class="card shadow-sm day-card mb-3">
          <div class="card-header bg-white p-0">
                        <button
              class="btn btn-link w-100 text-start fw-bolder text-decoration-none px-3 py-2 day-toggle d-flex justify-content-between align-items-center"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#${collapseId}"
              aria-expanded="false"
              aria-controls="${collapseId}"
            >
              <span>${koDayTitle(dayDate)}</span>
              <span class="badge bg-secondary">${count}건</span>
            </button>
          </div>
          <div id="${collapseId}" class="collapse">
            <div class="card-body p-0">
              <div class="schedule-grid">${slots.join('')}</div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  const es = new EventSource("/sse/schedule");
  es.addEventListener("reserv_created", (e) => {
    location.reload();
  });
</script>

</body>
</html>
